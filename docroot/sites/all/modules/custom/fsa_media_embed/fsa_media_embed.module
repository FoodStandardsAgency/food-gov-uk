<?php
/**
 * @file
 * Module code for the FSA media embed module.
 */

/**
 * Implements hook_token_info().
 */
function _fsa_media_embed_token_info() {
  $type = array(
    'name' => t('YouTube video embeds'),
    'description' => t('Allows YouTube videos to be embedded via tokens.'),
  );
  $youtube['id'] = array(
    'name' => t('Video ID'),
    'description' => t('The ID of the video on YouTube'),
  );
  return array(
    'types' => array('youtube' => $type),
    'tokens' => array('youtube' => $youtube),
  );
}


/**
 * Implements hook_tokens().
 */
function _fsa_media_embed_tokens($type, $tokens, array $data = array(), array $options = array()) {

  $replacements = array();

  if ($type == 'youtube') {
    foreach ($tokens as $name => $original) {
      $video = array(
        '#theme' => 'youtube_embed',
        '#youtube_id' => filter_xss($name),
      );
      $replacements[$original] = drupal_render($video);
    }
  }
  return $replacements;
}

/**
 * Implements hook_theme().
 * @return array
 *   Theme hooks defined by this module.
 */
function fsa_media_embed_theme() {
  return array(
    'youtube_embed' => array(
      'template' => 'theme/youtube-embed',
      'variables' => array(
        'youtube_id' => NULL,
        'width' => 460,
        'height' => 259,
      ),
    ),
  );
}

/**
 * Implements template_preprocess_html().
 */
function fsa_media_embed_preprocess_html(&$variables) {
  // Don't affect admin paths.
  if (path_is_admin(current_path())) {
    return;
  }
  // Add our CSS file
  drupal_add_css(drupal_get_path('module', 'fsa_media_embed') . '/css/fsa-media-embed.css');
}

/**
 * Preprocess function for YouTube video embeds.
 *
 * @param array $variables
 *   Template variables, passed by reference. Includes:
 *   - 'youtube_id' : The ID of the YouTube video to embed
 *   - 'width' : The width of the embedded video
 *   - 'height' : The height of the embedded video
 */
function template_preprocess_youtube_embed(&$variables) {
  $variables['iframe_attributes_array']['allowfullscreen'] = 'true';
  if (!empty($variables['width']) && !empty($variables['height'])) {
    $variables['iframe_attributes_array']['width'] = $variables['width'];
    $variables['iframe_attributes_array']['height'] = $variables['height'];
  }
}


/**
 * Process function for YouTube video embeds.
 */
function template_process_youtube_embed(&$variables) {
  // Add classes to the attributes array if not already present. This is
  // typically done by `omega_cleanup_attributes()`, but this function is not
  // always called during rendering.
  if (empty($variables['attributes_array']['class']) && !empty($variables['classes_array'])) {
    $variables['attributes_array']['class'] = $variables['classes_array'];
    $variables['attributes'] = drupal_attributes($variables['attributes_array']);
  }
  // Flatten the iframe_attributes array.
  $variables['iframe_attributes'] = drupal_attributes($variables['iframe_attributes_array']);
}


/**
 * Implements hook_filter_info().
 */
function fsa_media_embed_filter_info() {
  $filters = array();
  $filters['fsa_media_embed'] = array(
    'title' => t('Embed media'),
    'description' => t('Allows easy embedding of YouTube and other media'),
    'process callback' => '_fsa_embed_media_filter_media_embed'
  );
  return $filters;
}


/**
 * Filter process callback
 */
function _fsa_embed_media_filter_media_embed($text, $filter, $format, $langcode, $cache, $cache_id) {
  // Regex Pattern to match YouTube embeds
  // @todo Make this more general to support other types - each with own
  // callback - array?
  $pattern = "/\[youtube:.*?\]/";
  // Replace the embed shortcuts with the actual embed code
  $text = preg_replace_callback($pattern, '_fsa_embed_media_replacement_callback', $text);
  return $text;
}


/**
 * Helper function for preg_replace_callback().
 */
function _fsa_embed_media_replacement_callback($text = NULL) {
  if (is_array($text)) {
    $text = $text[0];
  }
  $output = '';
  $build = array();
  $pattern = "/\[([a-zA-Z0-9]+):(.*?)\]/";
  $provider = preg_replace($pattern, '$1', $text);
  $identifier = preg_replace($pattern, '$2', $text);
  $videos = explode(',', $identifier);
  foreach ($videos as $item) {
    // Create a render array for the video
    $video = array(
      '#theme' => 'youtube_embed',
      '#youtube_id' => trim(filter_xss($item)),
    );
   $build[$item] = $video;
  }
  if (count($videos) > 1) {
    // @todo Create a mulitple-wrapper theme function/template to suppor
    //   wrapper_attributes. It feels dirty to include markup here. It should be
    //   properly themeable and more generic.
    $build['#prefix'] = '<div class="youtube-embed-multiple">';
    $build['#suffix'] = '</div>';
    //$build['#theme_wrappers'] = array('container');
    //$build['#wrapper_attributes'] = array('class' => 'youtube-embed-multiple');
  }
  $output = drupal_render($build);
  return $output;
}
