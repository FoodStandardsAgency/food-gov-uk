<?php

/**
 * @file
 * Provides custom features for FacetAPI facets.
 */

/**
 * Implements hook_theme_registry_alter().
 */
function facets_select_theme_registry_alter(&$theme_registry) {

  if (isset($theme_registry['facetapi_widget_links'])) {
    $theme_registry['facetapi_widget_links']['function'] = 'theme_facets_select_facetapi_widget_links';
  }
}


/**
 * Alter the facetapi_select field pararameters before rendering.
 *
 * This hook is invoked after the form parameters of facetapi_select field
 * are generated in a facetapi_select_facet_form() function. This provides
 * a way to easily change the field parameters like changing id attribute
 * adding name attribute, removing the autosubmit js, etc.
 *
 * @param $form
 * A form parameters to alter generated by facetapi_select_facet_form().
 * @param $form_state
 * $form_state parameter from facetapi_select_facet_form().
 * @param $options
 * $options parameter from facetapi_select_facet_form().
 * @param $count
 * $count parameter from facetapi_select_facet_form().
 */
function facets_select_facetapi_select_facet_form_alter(&$form, $form_state, $options, $count) {
  // Add a custom name attribute to facet field.
  $attribute_name = 'facetapi_select_facet_form_' . $count . '_name';
  $form['facets']['#name'] = $attribute_name;

  if ($options[0] == t('Entire Website')) {
    $form['facets']['#title'] = t('Search by section');
  }

  if ($options[0] == t('All nations')) {
    $form['facets']['#title'] = t('Search by nation');
  }

  if ($options[0] == t('All news types')) {
    $form['facets']['#title'] = t('Search by news type');
  }

  if ($options[0] == t('Any status')) {
    $form['facets']['#title'] = t('Browse by status');
  }

  if ($options[0] == t('Any year of consultation')) {
    $form['facets']['#title'] = t('Browse by year');
  }

  if ($options[0] == t('All business types')) {
    $form['facets']['#title'] = t('Search by business type');
  }

  if ($options[0] == t('All topics')) {
    $form['facets']['#title'] = t('Search by topic');
  }

  if ($options[0] == t('All audit types')) {
    $form['facets']['#title'] = t('Search by audit type');
  }

  if ($options[0] == t('All audit states')) {
    $form['facets']['#title'] = t('Search by audit states');
  }

  if ($options[0] == t('All authority types')) {
    $form['facets']['#title'] = t('Search by authority type');
  }

  if ($options[0] == t('All years')) {
    $form['facets']['#title'] = t('Search by year');
  }

  if ($options[0] == t('All action plan statuses')) {
    $form['facets']['#title'] = t('Search by action plan');
  }

}

function theme_facets_select_facetapi_widget_links($variables) {
  $element = $variables['element'];
  $build = $element['#build'];
  $widget = $element['#widget'];
  $widget_build = $widget->getBuild();
  $output = '';

  if ($options = facets_select_facetapi_link_options($build, t('anytime'))) {
    $title = t('Search by date (updated/published)');
    $output = facets_select_create_select($options, $title);
  }

  return $output;
}

function facets_select_create_select($options, $title) {
  drupal_add_js(drupal_get_path('module', 'facets_select') . '/js/facets_select.js', 'file');

  $output = '<div class="facetapi-jumper-menu">';
  $select = element_info('select');
  $select['#title'] = $title;
  $select['#options'] = $options;
  $output .= render($select);
  $output .= '</div>';
  return $output;
}


function facets_select_facetapi_link_options($items, $empty_option = NULL, $depth = 0) {
  global $base_url;
  $options = array();

  if ($depth == 0 && $empty_option) {
    $options[''] = $empty_option;
  }

  foreach ($items as $item) {
    if (empty($item['#active'])) {
      $label = $item['#markup'] . ($item['#count'] ? ' (' . $item['#count'] . ')' : '');
    }
    else {
      $label = '(-) ' . $item['#markup'];
    }
    $href = url($item['#path'], array('query' => empty($item['#query']) ? array() : $item['#query'], 'absolute' => TRUE));
    $options[$href] = ($depth ? str_repeat('-', $depth) . ' ' : '') . $label;
    if (!empty($item['#item_children'])) {
      // Render nested list.
      $options += _theme_facetapi_link_options($item['#item_children'], NULL, $depth + 1);
    }
  }

  return $options;
}
